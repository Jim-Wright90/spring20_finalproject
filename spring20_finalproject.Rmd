---
title: "spring20_finalproject"
author: "Asha Yadav, Alejandra Garcia Isaza, and Mark Hammond"
date: "4/28/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(rio)
library(here)
library(naniar)
library(colorblindr)
library(plotly)
library(tigris)
library(geofacet)
library(cowplot)
library(ggrepel)
library(ggalt)
library(forcats)

theme_set(theme_minimal())

```

```{r}
# importing the data

NCSH <- import(here("data","2017-2018 NSCH_Topical_DRC_Dec 2019.csv"), setclass = "tbl_df")
state <- import(here("data","fips_state.csv"))
# Left_join to add states in the NCSH dataset

final_data <- left_join(NCSH, state, by = "FIPSST")


```


Final Project Components

* No code is used repetitively (no more than twice) [10 points]
* More than one variant of purrr::map is used [10 points]
* At least one {purrr} function outside the basic map family (walk_*, reduce, modify_*, etc.) [10 points]
* At least one instance of parallel iteration (e.g., map2_*, pmap_*) [10 points]
* At least one use case of purrr::nest %>% mutate() [10 points]
* At least two custom functions [20 points; 10 points each]
  ** Each function must do exactly one thing
  ** The functions may replicate the behavior of a base function - as noted above this is about practicing the skills you learn in class
* Code is fully reproducible and housed on GitHub [10 points]
* No obvious errors in chosen output format [10 points]
* Deployed on the web and shareable through a link [10 points]

```{r}
selected_data <- final_data %>%
  select(HHID, HHLANGUAGE, SC_AGE_YEARS, SC_SEX, MOMAGE, HHCOUNT, K6Q20, K11Q60, K11Q61, K11Q62, S9Q34, K10Q14, ACE1, ACE3, ACE4, ACE5, ACE6, ACE7, ACE8, ACE9, ACE10, RECOGABC, A1_GRADE, A2_GRADE, K6Q60_R, K6Q61_R, FOODSIT, K8Q30, CONFIDENT, povlev4_1718, AdultEduc_1718, WrkngPoor_1718, ACEct_1718, ACE2more_1718, State) %>%
  janitor::clean_names() %>% # cleaning names
  filter(sc_age_years <= 5, ace2more_1718 > 1)


```



```{r}

# 1 custom function on missing data, nest, mutate and pmap to produce plot for 51 states (by Asha)

selected_data <- final_data %>%
  select(HHID, HHLANGUAGE, SC_AGE_YEARS, SC_SEX, MOMAGE, HHCOUNT, K6Q20, K11Q60, K11Q61, K11Q62, S9Q34, K10Q14, ACE1, ACE3, ACE4, ACE5, ACE6, ACE7, ACE8, ACE9, ACE10, RECOGABC, A1_GRADE, A2_GRADE, K6Q60_R, K6Q61_R, FOODSIT, K8Q30, CONFIDENT, povlev4_1718, AdultEduc_1718, WrkngPoor_1718, ACEct_1718, ACE2more_1718, State) %>%
  janitor::clean_names() %>% # cleaning names
  filter(sc_age_years <= 5, ace2more_1718 > 1) # filtering for 5 years old

selected_data1 <-selected_data %>%
  select(state, ace2more_1718)

# creating a function to recode missing data

# vector with missing values in my dataset
missing_vals <- c(90, 95, 99)

# function that returns true if values in vector are equal to missing_vals. The function takes a vector x, and specified values of missing data
recode_missing <- function(x, missing_vals = c(90, 95, 99)) {
  test <- x %in% missing_vals
  ifelse(test, NA, x)
}

# function that recodes missing values to NA. The function takes a dataframe with variables with missing data, and specified values of missing data
recode_missing_df <- function(df, missing_vals = c(90, 95, 99)) {
  modify(df, ~recode_missing(.x, missing_vals)) # here uses the function created above
}

selected_data1 <- recode_missing_df(selected_data1) %>%
  drop_na() %>%
  mutate(ACE = factor(ace2more_1718),
         ACE = recode_factor(ACE,
                          "2" = "Exp 1 ACE",
                          "3" = "Exp 2 Ace"))

selected_data1 <- selected_data1 %>%
  group_by(state, ACE) %>%
  count(ACE)

selected_data1 <- selected_data1 %>%
  group_by(state) %>%
  mutate(tot = sum(n))

# Creating a column for label

library(english)
library(glue)
selected_data1 <- selected_data1 %>%
  mutate(label =
  glue("{str_to_title(as.english(tot))} Children experienced ACE"))


# Plot for one state

selected_data1 %>%
  filter(state == "Alabama")

ggplot(selected_data1, aes(ACE, n)) +
  geom_col(aes(fill = n)) +
  scale_fill_distiller(type = "seq",
                       limits = c(0, max(selected_data1$n)),
                       palette = "BuPu",
                       direction = 1) +
  ylim(0, max(selected_data1$n)) +
  coord_flip() +
  labs(title = "Number of children experienced ACE : Alabama",
       x = "Adverse Childhood Experience",
       y = "Number of children under 5s",
       caption = unique(selected_data1$label))

#Produce plots for 51 states using pmap
final_plots <- selected_data1 %>%
  group_by(state, label) %>%
  nest() %>%
  mutate(plots = pmap(list(state, label, data),
                      ~ggplot(..3, aes(ACE, n)) +
                        geom_col(aes(fill = n)) +
                        scale_fill_distiller(type = "seq",
                                             limits = c(0, max(selected_data1$n)),
                                             palette = "BuPu",
                                             direction = 1) +
                        ylim(0, max(selected_data1$n)) +
                        coord_flip() +
                        labs(title = glue("Number of children experienced ACE : {..1}"),
                             x = "Adverse Childhood Exp",
                             y = "Number of Children",
                             caption = ..2)))
final_plots$plots[[5]]
# Create directory to save plots

fs::dir_create(here::here("plots", "selected_data1"))

# Create file path
files <- str_replace_all(tolower(final_plots$state), " ", "-")
paths <- here::here("plots", "selected_data1", glue("{files}.png"))
paths

#save plots
walk2(paths, final_plots$plots, ggsave,
      width = 9.5, 
      height = 6.5,
      dpi = 500)
```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
